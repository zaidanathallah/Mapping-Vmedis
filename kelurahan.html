<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapping Kelurahan</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div id="kelurahan-mapping-content" class="collapsed" style="display: none">
      <div class="main-content-kelurahan" id="main-content-kelurahan">
        <div id="kelurahanMappingContentContainer">
          <div class="header-container" id="header-kelurahan">
            <!-- Heading -->
            <h2 id="main-title-kelurahan" class="hidden">Mapping Kelurahan</h2>

            <div class="container">
              <div class="content-header">
                <button id="cari-kelurahan" class="btn-custom btn-search">
                  <i class="fas fa-search"></i> Search
                </button>

                <button id="refresh-kelurahan" class="btn-custom btn-refresh">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>

                <button id="matching-kelurahan" class="btn-custom btn-matching">
                  <i class="fas fa-link"></i> Matching
                </button>

                <div style="display: inline-flex; align-items: center">
                  <label for="sinkronMappingkelurahan" style="margin-right: 8px"
                    >Sinkron Mapping</label
                  >
                  <select
                    id="sinkronMappingkelurahan"
                    class="form-control"
                    style="width: auto"
                  >
                    <option value="belum">Belum</option>
                    <option value="sudah">Sudah</option>
                    <option value="semua">Semua</option>
                  </select>
                </div>

                <div
                  class="sorting-options"
                  style="display: inline-flex; align-items: center"
                >
                  <label for="sortBy" style="margin-right: 8px">Urutkan</label>
                  <select id="sortBy" class="form-control" style="width: auto">
                    <option value="provinsi_kota_kecamatan_kelurahan_asc">
                      Provinsi, Kota, kecamatan, dan kelurahan(A-Z)
                    </option>
                  </select>
                </div>
              </div>

              <table id="data-obat-kelurahan">
                <thead>
                  <tr>
                    <th class="checkbox-column-kelurahan">
                      <button
                        class="btn btn-select"
                        id="select-30-btn-kelurahan"
                      >
                        <i class="fas fa-check-square"></i> 30
                      </button>
                      <button
                        class="btn btn-delete"
                        id="delete-selected-btn-kelurahan"
                      >
                        <i class="fas fa-square"></i>
                      </button>
                    </th>
                    <th style="font-size: 13px; text-align: left">Provinsi</th>
                    <th style="font-size: 13px; text-align: left">
                      Provinsi Aktif
                    </th>
                    <th style="font-size: 13px; text-align: left">
                      ID Provinsi Satu Sehat
                    </th>
                    <th style="font-size: 13px; text-align: left">Kota</th>
                    <th style="font-size: 13px; text-align: left">
                      Kota Aktif
                    </th>
                    <th style="font-size: 13px; text-align: left">
                      ID Kota Satu Sehat
                    </th>
                    <th style="font-size: 13px; text-align: left">Kecamatan</th>
                    <th style="font-size: 13px; text-align: left">
                      Kecamatan Aktif
                    </th>
                    <th style="font-size: 13px; text-align: left">
                      ID Kecamatan Satu Sehat
                    </th>
                    <th style="font-size: 13px; text-align: left">
                      ID Kelurahan
                    </th>
                    <th style="font-size: 13px; text-align: left">Kelurahan</th>
                    <th style="font-size: 13px; text-align: left">
                      Kelurahan Aktif
                    </th>
                    <th style="font-size: 13px; text-align: left">
                      ID Kelurahan Satu Sehat
                    </th>
                  </tr>
                  <tr>
                    <th></th>

                    <th>
                      <input
                        id="search-provinsi"
                        placeholder="Cari provinsi"
                        type="text"
                        style="text-align: left"
                      />
                    </th>
                    <th>
                      <select
                        id="search-provinsiaktif"
                        style="text-align: left"
                      >
                        <option value="">Semua</option>
                        <!-- Tambahkan opsi untuk menampilkan semua data -->
                        <option value="0">Non Aktif</option>
                        <option value="1">Aktif</option>
                      </select>
                    </th>
                    <th>
                      <input
                        id="search-idprovinsi_satusehat"
                        placeholder="Cari ID provinsi Satu Sehat"
                        type="text"
                        style="text-align: left"
                      />
                    </th>

                    <th>
                      <input
                        id="search-kota"
                        placeholder="Cari kota"
                        type="text"
                        style="text-align: left"
                      />
                    </th>
                    <th>
                      <select id="search-kotaaktif" style="text-align: left">
                        <option value="">Semua</option>
                        <!-- Tambahkan opsi untuk menampilkan semua data -->
                        <option value="0">Non Aktif</option>
                        <option value="1">Aktif</option>
                      </select>
                    </th>

                    <th>
                      <input
                        id="search-idkota_satusehat"
                        placeholder="Cari ID kota Satu Sehat"
                        type="text"
                        style="text-align: left"
                      />
                    </th>

                    <th>
                      <input
                        id="search-kecamatan"
                        placeholder="Cari kecamatan"
                        type="text"
                        style="text-align: left"
                      />
                    </th>
                    <th>
                      <select
                        id="search-kecamatanaktif"
                        style="text-align: left"
                      >
                        <option value="">Semua</option>
                        <!-- Tambahkan opsi untuk menampilkan semua data -->
                        <option value="0">Non Aktif</option>
                        <option value="1">Aktif</option>
                      </select>
                    </th>

                    <th>
                      <input
                        id="search-idkecamatan_satusehat"
                        placeholder="Cari ID kecamatan Satu Sehat"
                        type="text"
                        style="text-align: left"
                      />
                    </th>

                    <th>
                      <input
                        id="search-idkelurahan"
                        placeholder="Cari ID kelurahan"
                        type="text"
                        style="text-align: left"
                      />
                    </th>

                    <th>
                      <input
                        id="search-kelurahan"
                        placeholder="Cari kelurahan"
                        type="text"
                        style="text-align: left"
                      />
                    </th>

                    <th>
                      <select
                        id="search-kelurahanaktif"
                        style="text-align: left"
                      >
                        <option value="">Semua</option>
                        <!-- Tambahkan opsi untuk menampilkan semua data -->
                        <option value="0">Non Aktif</option>
                        <option value="1">Aktif</option>
                      </select>
                    </th>

                    <th>
                      <input
                        id="search-idkelurahan_satusehat"
                        placeholder="Cari ID kelurahan Satu Sehat"
                        type="text"
                        style="text-align: left"
                      />
                    </th>
                  </tr>
                </thead>

                <div
                  id="pagination-info-kelurahan"
                  style="margin-top: 10px; font-size: 14px"
                ></div>

                <tbody id="obat-list-kelurahan"></tbody>
              </table>

              <div id="pagination-controls-kelurahan"></div>

              <div id="sync-results-kelurahan" style="margin-top: 20px"></div>

              <!-- Modal Konfirmasi Matching -->
              <div id="confirmationModalkelurahan" class="modal">
                <div class="modal-content">
                  <p>Apakah anda yakin akan memproses data yang terpilih?</p>
                  <button
                    id="confirmProcesskelurahan"
                    class="btn-custom btn-confirm"
                  >
                    Proses
                  </button>
                  <button
                    id="cancelProcesskelurahan"
                    class="btn-custom btn-cancel"
                  >
                    Batal
                  </button>
                </div>
              </div>

              <!-- Modal Dialog for refresh confirmation -->
              <div id="confirmRefreshModalkelurahan" class="modal">
                <div class="modal-content">
                  <div class="modal-header">Konfirmasi Refresh Data</div>
                  <p>Apakah anda yakin akan melakukan refresh data?</p>
                  <button id="prosesRefreshkelurahan">Proses</button>
                  <button onclick="closeModal('confirmRefreshModalkelurahan')">
                    Batal
                  </button>
                </div>
              </div>

              <!-- Modal Loading -->
              <div id="loadingModalkelurahan" class="modal">
                <div class="modal-content">
                  <p>Memproses, mohon tunggu...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="selectModalkelurahan" class="modal">
      <div class="modal-content">
        <div class="modal-header">Konfirmasi Pilihan</div>
        <p>
          Memilih semua data akan mereset data terpilih sebelumnya, apakah anda
          yakin untuk melanjutkan?
        </p>
        <button onclick="confirmSelect()">Proses</button>
        <button onclick="closeModal('selectModalkelurahan')">Batal</button>
      </div>
    </div>

    <!-- Modal Dialog for deleting selected data -->
    <div id="deleteModalkelurahan" class="modal">
      <div class="modal-content">
        <div class="modal-header">Konfirmasi Hapus</div>
        <p>Apakah anda yakin menghapus semua data yang terpilih?</p>
        <button onclick="confirmDelete()">Proses</button>
        <button onclick="closeModal('deleteModalkelurahan')">Batal</button>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
      // Pastikan konten Mapping Provinsi tampil setelah halaman dimuat
      const kelurahanMappingContent = document.getElementById(
        "kelurahan-mapping-content"
      );
      if (kelurahanMappingContent) {
        kelurahanMappingContent.style.display = "block"; // Menampilkan form
      }

      // Pastikan Fungsi Dimuat di Awal

      document.getElementById("select-30-btn-kelurahan").onclick = function () {
        document.getElementById("selectModalkelurahan").style.display = "block";
      };

      function confirmSelect() {
        const checkboxes = document.querySelectorAll(".select-checkbox");
        let selectedCount = 0;

        checkboxes.forEach((checkbox, index) => {
          console.log(
            `Checkbox ${index}: Disabled=${checkbox.disabled}, Checked=${checkbox.checked}`
          ); // Log each checkbox's state
          if (!checkbox.disabled && selectedCount < 30) {
            checkbox.checked = true; // Check the box if it's not disabled
            selectedCount++; // Increase the count for each selected checkbox
          }
        });

        console.log("Total selected checkboxes:", selectedCount); // Check how many were selected
        closeModal("selectModalkelurahan");
      }

      // Delete selected data with confirmation
      document.getElementById("delete-selected-btn-kelurahan").onclick =
        function () {
          document.getElementById("deleteModalkelurahan").style.display =
            "block";
        };

      let currentPage = 1; // Halaman saat ini
      const itemsPerPage = 30; // Jumlah item per halaman
      const pagesToShow = 5; // Jumlah angka halaman yang ditampilkan sekaligus
      let totalPages = 0; // Total halaman yang akan dihitung setelah data dimuat
      let searchParams = {}; // Simpan pencarian terakhir

      // Fungsi untuk memuat data kota
      function loadKelurahanList(searchParams = {}) {
        console.log("Memuat data dengan parameter pencarian:", searchParams);
        const tableBody = document.getElementById("obat-list-kelurahan");

        // Tambahkan parameter pencarian ke URL
        const queryString = new URLSearchParams(searchParams).toString();
        console.log(
          `Query string yang dikirim: get_kelurahan.php?${queryString}`
        );

        fetch(`get_kelurahan.php?${queryString}`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Data yang diterima:", data);

            // Kosongkan tabel sebelum mengisi
            tableBody.innerHTML = "";

            const totalData = data.length; // Hitung total data

            // Jika tidak ada data, tampilkan pesan "No results found"
            if (totalData === 0) {
              tableBody.innerHTML = `
                                <tr>
                                    <td colspan="7" class="text-center">No results found</td>
                                </tr>`;
              // Update informasi pagination dan sembunyikan pagination jika tidak ada data
              updatePaginationInfokelurahan(totalData);
              document.getElementById(
                "pagination-controls-kelurahan"
              ).innerHTML = "";
              return; // Berhenti di sini jika tidak ada data
            }

            totalPages = Math.ceil(totalData / itemsPerPage); // Hitung total halaman

            // Tentukan indeks awal dan akhir data untuk halaman saat ini
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            // Ambil data yang sesuai dengan halaman saat ini
            const pageData = data.slice(startIndex, endIndex);

            // Gabungkan semua baris sebagai string sebelum menambahkan ke tabel
            let rows = pageData
              .map((Kelurahan) => {
                // Ubah nilai kotaaktif menjadi "Aktif" atau "Non Aktif"
                const kotaAktifText =
                  Kelurahan.kotaaktif === "1" ? "Aktif" : "Non Aktif";

                // Ubah nilai provinsiaktif menjadi "Aktif" atau "Non Aktif"
                const provinsiAktifText =
                  Kelurahan.provinsiaktif === "1" ? "Aktif" : "Non Aktif";

                const kecamatanAktifText =
                  Kelurahan.kecamatanaktif === "1" ? "Aktif" : "Non Aktif";

                // Ubah nilai provinsiaktif menjadi "Aktif" atau "Non Aktif"
                const kelurahanAktifText =
                  Kelurahan.kelurahanaktif === "1" ? "Aktif" : "Non Aktif";

                // Tentukan apakah checkbox harus dinonaktifkan
                const isDisabled =
                  Kelurahan.idkelurahan_satusehat?.trim() ||
                  Kelurahan.provinsiaktif === "0" ||
                  !Kelurahan.provinsiaktif ||
                  Kelurahan.kotaaktif === "0" ||
                  !Kelurahan.kotaaktif ||
                  Kelurahan.kecamatanaktif === "0" ||
                  !Kelurahan.kecamatanaktif ||
                  Kelurahan.kelurahanaktif === "0" ||
                  !Kelurahan.kelurahanaktif
                    ? "disabled"
                    : "";

                return `
                                <tr>
                                    <td class="checkbox-column-kelurahan">
                                        <input type="checkbox" class="select-checkbox" ${isDisabled}>
                                        <button class="delete-icon-kelurahan" onclick="delete_idkelurahan_Satusehat('${Kelurahan.kelurahan}')">üóëÔ∏è</button>
                                    </td>
                                    <td>${Kelurahan.provinsi}</td>
                                    <td>${provinsiAktifText}</td>
                                    <td>${Kelurahan.idprovinsi_satusehat}</td>
                                    <td>${Kelurahan.kota}</td>
                                    <td>${kotaAktifText}</td>
                                    <td>${Kelurahan.idkota_satusehat}</td>
                                    <td>${Kelurahan.kecamatan}</td>
                                    <td>${kecamatanAktifText}</td>
                                    <td>${Kelurahan.idkecamatan_satusehat}</td>
                                    <td>${Kelurahan.idkelurahan}</td>
                                    <td>${Kelurahan.kelurahan}</td>
                                    <td>${kelurahanAktifText}</td>
                                    <td>${Kelurahan.idkelurahan_satusehat}</td>
                                </tr>`;
              })
              .join(""); // Gabungkan semua baris menjadi satu string

            // Tambahkan baris ke tabel sekali saja
            tableBody.innerHTML = rows;

            // Update kontrol pagination
            updatePaginationControlskelurahan();
            // Update informasi pagination
            updatePaginationInfokelurahan(totalData);
          })
          .catch((error) => console.error("Error:", error));
      }

      // Fungsi Global
      window.delete_idkelurahan_Satusehat = function (kelurahan) {
        if (
          confirm("Apakah Anda yakin ingin menghapus ID kelurahan Satu Sehat?")
        ) {
          fetch(`delete_idkelurahan_Satusehat.php?kelurahan=${kelurahan}`, {
            method: "GET",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("ID kelurahan Satu Sehat berhasil dihapus");
                loadKelurahanList(searchParams); // Muat ulang data setelah penghapusan
              } else {
                alert("Gagal menghapus ID kelurahan Satu Sehat");
              }
            })
            .catch((error) => console.error("Error:", error));
        }
      };

      // Fungsi untuk mengupdate kontrol pagination
      function updatePaginationControlskelurahan() {
        const paginationContainer = document.getElementById(
          "pagination-controls-kelurahan"
        );
        paginationContainer.innerHTML = ""; // Kosongkan kontrol pagination sebelumnya

        const startPage = Math.max(
          1,
          currentPage - Math.floor(pagesToShow / 2)
        );
        const endPage = Math.min(totalPages, startPage + pagesToShow - 1);

        // Tambahkan tombol "Previous"
        const prevButton = document.createElement("button");
        prevButton.innerHTML = "&laquo;"; // Karakter panah ke kiri
        prevButton.classList.add("page-button");
        prevButton.disabled = currentPage === 1; // Nonaktifkan jika di halaman pertama

        prevButton.addEventListener("click", function () {
          if (currentPage > 1) {
            currentPage--; // Kurangi halaman saat ini
            loadKelurahanList(searchParams); // Muat data untuk halaman sebelumnya dengan parameter pencarian
          }
        });

        paginationContainer.appendChild(prevButton);

        // Buat tombol untuk setiap halaman yang ditampilkan
        for (let i = startPage; i <= endPage; i++) {
          const pageButton = document.createElement("button");
          pageButton.innerText = i;
          pageButton.classList.add("page-button");

          // Tambahkan class "active" untuk halaman yang sedang aktif
          if (i === currentPage) {
            pageButton.classList.add("active"); // Tambahkan class aktif (untuk warna merah)
          }

          pageButton.addEventListener("click", function () {
            currentPage = i;
            loadKelurahanList(searchParams); // Muat data untuk halaman yang dipilih dengan parameter pencarian
          });

          paginationContainer.appendChild(pageButton);
        }

        // Tambahkan tombol "Next"
        const nextButton = document.createElement("button");
        nextButton.innerHTML = "&raquo;";
        nextButton.classList.add("page-button");
        nextButton.disabled = currentPage === totalPages;

        nextButton.addEventListener("click", function () {
          if (currentPage < totalPages) {
            currentPage++;
            loadKelurahanList(searchParams); // Muat data untuk halaman berikutnya dengan parameter pencarian
          }
        });

        paginationContainer.appendChild(nextButton);

        // Menambahkan total halaman di sebelah kanan panah
        const totalPagesSpan = document.createElement("span");
        totalPagesSpan.classList.add("total-pages-info");
        totalPagesSpan.innerText = `Total ${totalPages} pages`;
        paginationContainer.appendChild(totalPagesSpan);

        // Menambahkan tulisan "Go to page"
        const goToPageText = document.createElement("span");
        goToPageText.classList.add("go-to-page-text");
        goToPageText.innerText = " Go to page ";
        paginationContainer.appendChild(goToPageText);

        // Tambahkan input untuk memasukkan nomor halaman dan tombol Go
        const pageInput = document.createElement("input");
        pageInput.type = "number";
        pageInput.id = "page-input";
        pageInput.min = 1;
        pageInput.max = totalPages;
        pageInput.value = currentPage; // Set nilai input ke halaman saat ini
        pageInput.classList.add("page-input");

        const goButton = document.createElement("button");
        goButton.innerText = "Go";
        goButton.classList.add("go-button");

        goButton.addEventListener("click", function () {
          const pageNumber = parseInt(pageInput.value);

          if (
            !isNaN(pageNumber) &&
            pageNumber > 0 &&
            pageNumber <= totalPages
          ) {
            currentPage = pageNumber;
            loadKelurahanList(searchParams); // Muat data untuk halaman yang dipilih dengan parameter pencarian
          } else {
            alert(
              `Silakan masukkan angka yang valid antara 1 dan ${totalPages}`
            );
          }
        });

        // Tambahkan input dan tombol Go ke container pagination
        paginationContainer.appendChild(pageInput);
        paginationContainer.appendChild(goButton);
      }

      // Fungsi untuk memperbarui informasi pagination
      function updatePaginationInfokelurahan(totalData) {
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, totalData);

        const paginationInfo = document.getElementById(
          "pagination-info-kelurahan"
        );
        paginationInfo.textContent = `Menampilkan ${startIndex} - ${endIndex} data dari total ${totalData} data.`;
      }

      // Event listener for the search button
      document
        .getElementById("cari-kelurahan")
        .addEventListener("click", function () {
          currentPage = 1; // Reset to the first page each time a search is performed

          // Get the value of the search inputs and save them to the global searchParams variable
          searchParams = {
            IDKelurahan: document.getElementById("search-idkelurahan").value,
            kelurahan: document.getElementById("search-kelurahan").value,
            KelurahanAktif: document.getElementById("search-kelurahanaktif")
              .value, // Updated to get the combobox value
            IDKelurahanSatuSehat: document.getElementById(
              "search-idkelurahan_satusehat"
            ).value,
            kecamatan: document.getElementById("search-kecamatan").value,
            KecamatanAktif: document.getElementById("search-kecamatanaktif")
              .value, // Updated to get the combobox value
            IDKecamatanSatuSehat: document.getElementById(
              "search-idkecamatan_satusehat"
            ).value,
            kota: document.getElementById("search-kota").value,
            KotaAktif: document.getElementById("search-kotaaktif").value, // Updated to get the combobox value
            IDKotaSatuSehat: document.getElementById("search-idkota_satusehat")
              .value,
            provinsi: document.getElementById("search-provinsi").value,
            ProvinsiAktif: document.getElementById("search-provinsiaktif")
              .value, // Updated to get the combobox value
            IDProvinsiSatuSehat: document.getElementById(
              "search-idprovinsi_satusehat"
            ).value,
            idkelurahanStatus: document.getElementById(
              "sinkronMappingkelurahan"
            ).value,
            sortBy: document.getElementById("sortBy").value, // Ambil nilai sorting
          };

          loadKelurahanList(searchParams); // Load data with search parameters
        });

      // Fungsi untuk menampilkan modal loading
      function showLoading() {
        document.getElementById("loadingModalkelurahan").style.display =
          "block";
      }

      // Fungsi untuk menyembunyikan modal loading
      function hideLoading() {
        document.getElementById("loadingModalkelurahan").style.display = "none";
      }

      // Event listener untuk tombol Refresh
      document
        .getElementById("refresh-kelurahan")
        .addEventListener("click", function () {
          document.getElementById(
            "confirmRefreshModalkelurahan"
          ).style.display = "block"; // Tampilkan modal konfirmasi
        });

      // Event listener untuk tombol Proses di dalam modal konfirmasi refresh
      document
        .getElementById("prosesRefreshkelurahan")
        .addEventListener("click", function () {
          document.getElementById(
            "confirmRefreshModalkelurahan"
          ).style.display = "none"; // Sembunyikan modal konfirmasi
          showLoading(); // Tampilkan loading

          // Proses Refresh
          setTimeout(() => {
            console.log("Tombol Refresh diklik dan konfirmasi disetujui");
            loadKelurahanList(searchParams); // Muat ulang data tanpa mengubah pencarian

            hideLoading(); // Sembunyikan loading setelah data dimuat
          }, 1000); // Tambahkan sedikit delay agar transisi loading terlihat
        });

      // Fungsi untuk reset state dan form setelah mapping selesai
      function resetMappingFormkelurahan() {
        // Reset checkbox dan form
        document.querySelectorAll(".select-checkbox").forEach((checkbox) => {
          checkbox.checked = false;
        });

        document
          .querySelectorAll(".kemenkes-kelurahan-checkbox")
          .forEach((checkbox) => {
            checkbox.checked = false;
          });

        // Kosongkan isi kontainer hasil mapping
        const container = document.getElementById("sync-results-kelurahan");
        if (container) {
          container.innerHTML = ""; // Bersihkan hasil mapping sebelumnya
        }

        // Kosongkan data obat yang dipilih
        selectedDataKelurahan = [];

        // Kembalikan tampilan halaman Mapping Obat Vmedis dan sembunyikan verifikasi
        $("#VerificationkelurahanContent").hide(); // Menghapus elemen verifikasi sebelumnya
        $("#header-kelurahan").show(); // Tampilkan kembali header halaman utama
      }

      // Function to sanitize the medicine name (removes numbers and spaces, and adjusts case)
      function sanitizeNamekelurahan(name) {
        return name.replace(/[^a-zA-Z]/g, ""); // Only letters, lower case
      }

      async function fetchAccuracykelurahan(firstString, secondString) {
        console.log(
          `Calculating accuracy between: "${firstString}" and "${secondString}"`
        ); // Debugging log
        try {
          const response = await fetch("calculateAccuracyKelurahan.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firstString, secondString }),
          });

          if (!response.ok)
            throw new Error(`Error fetching accuracy: ${response.status}`);
          const data = await response.json();
          return data.accuracy || 0;
        } catch (error) {
          console.error("Error fetching accuracy:", error);
          return 0; // Return 0 on error
        }
      }

      // Batch accuracy calculation to reduce requests

      async function calculateAccuraciesBatchkelurahan(
        selectedKelurahanName,
        KelurahanData
      ) {
        // Sanitize and standardize the selected province name
        console.log("Selected kelurahan Name:", selectedKelurahanName);
        const sanitizedSelectedNameKelurahan = sanitizeNamekelurahan(
          selectedKelurahanName
        ).toLowerCase();

        // Process the province data in parallel to calculate accuracy
        const results = await Promise.all(
          KelurahanData.map(async (item) => {
            // Sanitize and standardize the Kemenkes province name
            const sanitizedItemNameKelurahan = sanitizeNamekelurahan(
              item.name
            ).toLowerCase();
            console.log("Kemenkes kelurahan Name:", item.name);
            // Direct match for 100% accuracy
            let accuracy =
              sanitizedSelectedNameKelurahan === sanitizedItemNameKelurahan
                ? 100
                : await fetchAccuracykelurahan(
                    sanitizedSelectedNameKelurahan,
                    sanitizedItemNameKelurahan
                  );

            return { ...item, accuracy: parseFloat(accuracy) };
          })
        );

        // Filter results to only include items with accuracy >= 40%
        const filteredResults = results.filter((item) => item.accuracy >= 40);

        return filteredResults;
      }

      // Otherwise, fetch the calculated accuracy from the backend

      // Function to fetch Kemenkes data from the API
      async function fetchKelurahanData(parent_code) {
        console.log("Fetching data for:", parent_code);

        if (!parent_code || parent_code.trim() === "") {
          console.error("Error: parent tidak diberikan.");
          return [];
        }

        try {
          const response = await fetch("api_kelurahan.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `IDKECAMATANSATUSEHAT=${encodeURIComponent(parent_code)}`,
          });

          if (!response.ok) {
            console.error(
              "Error fetching data from Kemenkes:",
              response.status,
              response.statusText
            );
            throw new Error("Gagal mengambil data dari Kemenkes");
          }

          const data = await response.json();
          console.warn("test data format :", data);

          if (data.data && Array.isArray(data.data)) {
            // Membatasi hanya 10 data yang diambil
            const limitedData = data.data.slice(0, 10);
            console.log("Limited Data:", limitedData);
            return limitedData;
          } else {
            console.warn("Unexpected data format:", data);
            return [];
          }
        } catch (error) {
          console.error("Error:", error);
          return [];
        }
      }

      // Function to process selected provinsi and fetch Kemenkes data
      async function processSelectedKelurahan(selectedDataKelurahan) {
        try {
          const KelurahanDataPromises = selectedDataKelurahan.map((Kelurahan) =>
            fetchKelurahanData(Kelurahan.IDKECAMATANSATUSEHAT)
          );
          const KelurahanDataResults = await Promise.all(KelurahanDataPromises);

          // Display verification content for selected provinces
          displayVerificationkelurahanContent(
            selectedDataKelurahan,
            KelurahanDataResults
          );
        } catch (error) {
          console.error(error);
          alert("Gagal mengambil data dari API Kemenkes");
        }
      }

      async function displayVerificationkelurahanContent(
        selectedDataKelurahan,
        KelurahanDataResults
      ) {
        const kelurahanMappingContentContainer = document.getElementById(
          "kelurahanMappingContentContainer"
        );

        // Ensure the container exists
        if (!kelurahanMappingContentContainer) {
          console.error(
            "Element with ID 'kelurahanMappingContentContainer' not found."
          );
          return;
        }

        // Remove previous content if it exists
        const previousVerificationkelurahanContent = document.getElementById(
          "VerificationkelurahanContent"
        );
        if (previousVerificationkelurahanContent)
          previousVerificationkelurahanContent.remove();

        // Process the data for verification
        const verificationKelurahanItems = await Promise.all(
          selectedDataKelurahan.map(async (selectedKelurahan, index) => {
            // Ensure provinsiDataResults[index] exists

            // Calculate accuracies for the current selected provinsi and Kemenkes data
            console.log("Selected kelurahan:", selectedKelurahan.KELURAHAN);
            const dataWithAccuracy = await calculateAccuraciesBatchkelurahan(
              selectedKelurahan.KELURAHAN,
              KelurahanDataResults[index]
            );
            dataWithAccuracy.sort((a, b) => b.accuracy - a.accuracy);
            console.log("Data with Accuracy:", dataWithAccuracy);

            // Create the list of Kemenkes provinces with accuracy data
            const kemenkesKelurahanOptions = dataWithAccuracy
              .map((kemenkesKelurahan, i) => {
                // Check if the accuracy is 100% and pre-check the checkbox
                const isChecked =
                  kemenkesKelurahan.accuracy === 100 ? "checked" : "";
                return `
                                                            <li>
                                                                <input type="checkbox" class="kemenkes-kelurahan-checkbox" id="kemenkes-${index}-${i}" value="${
                  kemenkesKelurahan.name
                }" 
                                                                data-selected-index="${index}" data-kemenkes-kelurahan='${JSON.stringify(
                  kemenkesKelurahan
                )}' ${isChecked} />
                                                                [${
                                                                  kemenkesKelurahan.accuracy
                                                                }%] - ${
                  kemenkesKelurahan.name
                } - ${kemenkesKelurahan.code}
                                                            </li>
                                                        `;
              })
              .join(""); // Join the array into a single string

            return `
                                                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                                            <div style="width: 45%;">
                                                                <h3>Kelurahan Terpilih</h3>
                                                                <strong>${
                                                                  index + 1
                                                                }.</strong> ${
              selectedKelurahan.PROVINSI
            } - ${selectedKelurahan.KOTA} - ${selectedKelurahan.KECAMATAN} - ${
              selectedKelurahan.KELURAHAN
            }
                                                            </div>
                                                            <div style="width: 45%;">
                                                                <h3>Data Kelurahan dari Kemenkes</h3>
                                                                ‚ñ∫ ${
                                                                  selectedKelurahan.KELURAHAN
                                                                }
                                                                <ul>${kemenkesKelurahanOptions}</ul>
                                                            </div>
                                                        </div>
                                                        <hr style="border: 1px solid #ddd; margin: 10px 0;">
                                                    `;
          })
        );

        const VerificationkelurahanContent = `
                                                    <div id="VerificationkelurahanContent" style="background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                                                        <h2 style="text-align: center;">Verifikasi Mapping Kelurahan</h2>
                                                        ${verificationKelurahanItems.join(
                                                          ""
                                                        )}
                                                        <button id="confirmMappingKelurahan" class="btn-confirm">Konfirmasi Mapping</button>
                                                        <button id="cancelMappingKelurahan" class="btn-cancel">Batal</button>
                                                    </div>
                                                `;

        // Use verificationContent here
        $("#kelurahanMappingContentContainer").append(
          VerificationkelurahanContent
        );
        $("#header-kelurahan").hide();

        $(document)
          .off("click", "#confirmMappingKelurahan")
          .on("click", "#confirmMappingKelurahan", async function (event) {
            event.preventDefault();
            const mappedKelurahan = [];

            selectedDataKelurahan.forEach((selectedKelurahan, index) => {
              const selectedCheckbox = document.querySelector(
                `.kemenkes-kelurahan-checkbox[data-selected-index="${index}"]:checked`
              );

              if (selectedCheckbox) {
                const kemenkesKelurahan = JSON.parse(
                  selectedCheckbox.getAttribute("data-kemenkes-kelurahan")
                );

                mappedKelurahan.push({
                  selected_kelurahan: {
                    IDKELURAHAN: selectedKelurahan.IDKELURAHAN, // Pastikan IDKOTA diambil dengan benar
                  },
                  mapped_kemenkes_kelurahan: {
                    IDKELURAHANSATUSEHAT: kemenkesKelurahan.code, // Pastikan kode diambil dari data Kemenkes
                  },
                });
              }
            });

            // Debugging: Log the mappedMeds array
            console.log("Mapped Meds Array:", mappedKelurahan);

            if (mappedKelurahan.length > 0) {
              try {
                await updateVmedisDatakelurahan(mappedKelurahan);

                $("#VerificationkelurahanContent").hide();
                $("#header-kelurahan").show();

                // Reload table with updated data
              } catch (error) {
                console.error(error);
                alert("Terjadi kesalahan saat mengupdate data ke Vmedis.");
              }
            } else {
              alert("Pilih setidaknya satu kelurahan untuk dimapping.");
            }
          });

        $(document)
          .off("click", "#cancelMappingKelurahan")
          .on("click", "#cancelMappingKelurahan", function () {
            $("#VerificationkelurahanContent").hide();
            $("#header-kelurahan").show();
          });
      }

      async function updateVmedisDatakelurahan(mappedKelurahan) {
        try {
          console.log("isi kelurahan:", mappedKelurahan);
          const response = await fetch("update_kelurahan.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              mapped_kelurahan: mappedKelurahan,
            }),
          });

          if (!response.ok) {
            console.error(
              "Failed to update Vmedis data:",
              response.status,
              response.statusText
            );
            throw new Error("HTTP error: " + response.status);
          }

          const result = await response.json();
          console.log("Server Response:", result);

          if (result.success) {
            resetMappingFormkelurahan();
            loadKelurahanList(searchParams); // Reload table with updated data
            alert("Data berhasil diupdate ke Vmedis!");
          } else {
            alert("Gagal mengupdate data ke Vmedis.");
          }
        } catch (error) {
          console.error("Error during update:", error);
          alert("Terjadi kesalahan saat mengupdate data ke Vmedis.");
        }
      }

      // Event handlers and existing logic
      const matchingButtonKelurahan =
        document.getElementById("matching-kelurahan");
      const confirmationModalKelurahan = document.getElementById(
        "confirmationModalkelurahan"
      );
      const confirmProcessButtonkelurahan = document.getElementById(
        "confirmProcesskelurahan"
      );
      const cancelProcessButtonkelurahan = document.getElementById(
        "cancelProcesskelurahan"
      );
      const kelurahanmappingContentContainer = document.getElementById(
        "kelurahanMappingContentContainer"
      );

      matchingButtonKelurahan.onclick = function () {
        const checkboxes = document.querySelectorAll(".select-checkbox");
        let anyChecked = Array.from(checkboxes).some(
          (checkbox) => checkbox.checked
        );

        if (anyChecked) {
          confirmationModalKelurahan.style.display = "block";
        } else {
          alert("Silakan pilih obat terlebih dahulu.");
        }
      };

      confirmProcessButtonkelurahan.onclick = async function () {
        // Tampilkan modal loading setelah tombol "Proses" diklik
        const loadingModal = document.getElementById("loadingModalkelurahan");
        loadingModal.style.display = "block";

        try {
          const selectedDataKelurahan = [];
          const checkboxes = document.querySelectorAll(".select-checkbox");

          // Pilih data dari checkbox yang dicentang
          checkboxes.forEach((checkbox, index) => {
            if (checkbox.checked) {
              // Ambil baris yang relevan berdasarkan checkbox
              const row = checkbox.closest("tr"); // Pastikan seleksi baris benar
              const cells = row.cells;
              const Provinsi = cells[1].textContent.trim();
              const ProvinsiAktif = cells[2].textContent.trim();
              const IDProvinsiSatuSehat = cells[3].textContent.trim();
              const Kota = cells[4].textContent.trim();
              const KotaAktif = cells[5].textContent.trim();
              const IDKotaSatuSehat = cells[6].textContent.trim();
              const Kecamatan = cells[7].textContent.trim();
              const KecamatanAktif = cells[8].textContent.trim();
              const IDKecamatanSatuSehat = cells[9].textContent.trim();
              const IDKelurahan = cells[10].textContent.trim();
              const Kelurahan = cells[11].textContent.trim();
              const KelurahanAktif = cells[12].textContent.trim();
              const IDKelurahanSatuSehat = cells[13].textContent.trim();

              if (IDKelurahan) {
                selectedDataKelurahan.push({
                  PROVINSI: Provinsi,
                  PROVINSIAKTIF: ProvinsiAktif,
                  IDPROVINSISATUSEHAT: IDProvinsiSatuSehat,
                  KOTA: Kota,
                  KOTAaktif: KotaAktif,
                  IDKOTASATUSEHAT: IDKotaSatuSehat,
                  KECAMATAN: Kecamatan,
                  KECAMATANAKTIF: KecamatanAktif,
                  IDKECAMATANSATUSEHAT: IDKecamatanSatuSehat,
                  IDKELURAHAN: IDKelurahan,
                  KELURAHAN: Kelurahan,
                  KELURAHANAKTIF: KelurahanAktif,
                  IDKELURAHANSATUSEHAT: IDKelurahanSatuSehat,
                });
              }
            }
          });

          // Validasi apakah ada data yang dipilih
          if (selectedDataKelurahan.length > 0) {
            confirmationModalKelurahan.style.display = "none"; // Tutup modal konfirmasi

            // Ambil obat yang dicentang dari hasil mapping Kemenkes
            const mappedKelurahan = [];

            document
              .querySelectorAll(".kemenkes-kelurahan-checkbox:checked")
              .forEach((checkbox) => {
                const kemenkesKelurahan = JSON.parse(
                  checkbox.getAttribute("data-kemenkes-kelurahan")
                ); // Ambil data kemenkesProv dari atribut data-kemenkes-prov
                if (kemenkesKelurahan) {
                  mappedKelurahan.push({
                    IDKELURAHAN: kemenkesKelurahan.IDKELURAHAN || null, // Nama obat dari checkbox
                    KELURAHAN: checkbox.value.trim, // Nama obat dari checkbox
                    IDKELURAHANSATUSEHAT: kemenkesKelurahan.code,
                    IDKECAMATANSATUSEHAT: kemenkesKelurahan.parent_code, // Kode KFA dari data Kemenkes
                  });
                }
              });

            console.log("Data Kelurahan Terpilih:", selectedDataKelurahan);
            console.log("Mapping Kelurahan Kemenkes:", mappedKelurahan);

            // Proses data yang dipilih dan hasil mapping
            await processSelectedKelurahan(
              selectedDataKelurahan,
              mappedKelurahan
            );
          } else {
            alert("Pilih Kelurahan terlebih dahulu untuk diproses.");
          }
        } catch (error) {
          console.error("Error saat memproses data:", error);
          alert("Terjadi kesalahan saat memproses data.");
        } finally {
          // Sembunyikan modal loading setelah selesai
          loadingModal.style.display = "none";
        }
      };

      cancelProcessButtonkelurahan.onclick = function () {
        confirmationModalKelurahan.style.display = "none";
      };

      window.onclick = function (event) {
        if (event.target == confirmationModalKelurahan) {
          confirmationModalKelurahan.style.display = "none";
        }
      };

      function confirmDelete() {
        // Select all checkboxes with the class 'select-checkbox'
        const checkboxes = document.querySelectorAll(".select-checkbox");
        // Iterate through each checkbox and uncheck it
        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });
        // Close the modal after unchecking
        closeModal("deleteModalkelurahan");
      }

      // Function to close the modal
      function closeModal(modalId) {
        console.log("Modal ID:", modalId); // Debugging log
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
          modalElement.style.display = "none";
        } else {
          console.error(`Modal with ID "${modalId}" not found.`);
        }
      }
    </script>
  </body>
</html>
